{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Crime Prediction System</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}?v=1">
    <style>
        /* Ensure the navigation is at the top-right */
        nav {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        nav a {
            margin-left: 15px; /* Add spacing between the links */
            text-decoration: none;
            color: #ffffff; /* You can customize the color as needed */
        }

        nav a:hover {
            color: #007bff; /* Change color on hover */
        }
    </style>
</head>

<body>

    <!-- Navigation Bar (Top-right) -->
    <nav>
        <a href="home/">Home</a>
        <a href="about/">About Us</a>
        <a href="index/">Sign In</a>
    </nav>

    <!-- Header Section -->
    <header>
        <div class="container">
            <h1>Crime Detection and Prevention</h1>
        </div>
    </header>

    <!-- Introduction Section -->
    <section class="intro">
        <div class="container">
            <h2>We are only here to protect you</h2>
        </div>
    </section>

    <!-- Emergency Alert Section with Camera and Location -->
    <section class="emergency-alert">
        <div class="container">
            <h2>Emergency Alert</h2>
            <p>If you're in danger, press the button below to start recording video and send an emergency alert with your location. Don't worry, we are with you.</p>
            
            <!-- Video Feed -->
            <video id="video-feed" width="320" height="240" autoplay></video>

            <br>
            <!-- Start/Stop Video Recording and Send Alert -->
            <button type="button" id="alert-button">Start Emergency Alert</button>
        </div>
    </section>

    <!-- Footer Section -->
    <footer>
        <div class="container">
            <p>&copy; @vasudha</p>
        </div>
    </footer>
    <script src="script.js"></script>

    <script>
        const videoElement = document.getElementById('video-feed');
        const emergencyButton = document.getElementById('alert-button');

        // Ensure the audio file path is correct
        const beepSound = new Audio("{% static 'C:/Users/Sudha/sudha/Scripts/crime_prediction/static/emergency-alarm-69780.mp3' %}");

        // Function to get the webcam stream
        function getWebcamStream() {
            return navigator.mediaDevices.getUserMedia({ video: true })
                .then((stream) => {
                    videoElement.srcObject = stream;
                    return stream;
                })
                .catch((err) => {
                    alert('Camera permission denied or not available: ' + err.message);
                    throw err;
                });
        }

        // Function to capture video data 
        function captureVideoData(stream) {
            return new Promise((resolve, reject) => {
                const mediaRecorder = new MediaRecorder(stream);
                const chunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    chunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    resolve(blob);
                };

                mediaRecorder.onerror = (error) => {
                    reject(error);
                };

                mediaRecorder.start();

                // Stop recording after 5 seconds (adjust this as needed)
                setTimeout(() => {
                    mediaRecorder.stop();
                }, 5000);
            });
        }

        // Function to get user's current location and display latitude & longitude in a popup
        function getLocation() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;

                        // Create a popup message displaying the coordinates
                        alert(`Your location has been detected:\nLatitude: ${latitude.toFixed(4)}, Longitude: ${longitude.toFixed(4)}`);

                        resolve({
                            latitude: latitude,
                            longitude: longitude
                        });
                    },
                    (error) => {
                        alert('Location permission denied or not available: ' + error.message);
                        reject(error);
                    }
                );
            });
        }

        // Handle the emergency button click
        emergencyButton.addEventListener('click', async () => {
            try {
                // Play the beep sound when the emergency button is clicked
                beepSound.play(); // Ensure sound is played on button click

                // Get webcam stream and display it in the video element
                const stream = await getWebcamStream();

                // Capture the video after a brief delay (wait for the video to start)
                setTimeout(async () => {
                    const videoData = await captureVideoData(stream);

                    // Get the location of the user
                    const location = await getLocation();

                    // Prepare form data to send to the backend
                    const formData = new FormData();
                    formData.append('video', videoData, 'emergency_video.webm');
                    formData.append('location', JSON.stringify(location));

                    // Send the data to the backend using fetch
                    const response = await fetch('/sendEmergencyAlert', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    console.log('Emergency alert sent successfully:', result);
                    alert('Emergency alert sent successfully!');

                    // Optionally, stop the webcam stream after sending the alert
                    stream.getTracks().forEach(track => track.stop());
                }, 1000); // Capture after 1 second delay to allow webcam stream to load

            } catch (error) {
                console.error('Error during emergency alert process:', error);
                alert('An error occurred. Please try again.');
            }
        });
    </script>

</body>
</html>
